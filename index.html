import React, { useState, useEffect } from 'react';
import { MapPin, Navigation, Clock, Search, Loader, TrendingUp, Award, Users } from 'lucide-react';

export default function PollingBoothFinder() {
    const [userLocation, setUserLocation] = useState(null);
    const [loading, setLoading] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedBooth, setSelectedBooth] = useState(null);
    const [activeTab, setActiveTab] = useState('booths');
    const [selectedYear, setSelectedYear] = useState(2024);
    const [hoveredState, setHoveredState] = useState(null);

    const candidates2028 = {
        republican: [
            { name: "Ron DeSantis", role: "Florida Governor", probability: "High" },
            { name: "Nikki Haley", role: "Former UN Ambassador", probability: "High" },
            { name: "Vivek Ramaswamy", role: "Entrepreneur", probability: "Medium" },
            { name: "Mike Pence", role: "Former VP", probability: "Medium" }
        ],
        democratic: [
            { name: "Gavin Newsom", role: "California Governor", probability: "High" },
            { name: "Gretchen Whitmer", role: "Michigan Governor", probability: "High" },
            { name: "Josh Shapiro", role: "Pennsylvania Governor", probability: "Medium" },
            { name: "Pete Buttigieg", role: "Transportation Secretary", probability: "Medium" }
        ],
        prediction: {
            likelyWinner: "Republican",
            confidence: "Moderate",
            reasoning: "Historical midterm patterns and economic trends favor opposition party"
        }
    };

    const electionHistory = [
        {
            year: 2024,
            winner: "Donald Trump",
            party: "Republican",
            electoral: 312,
            popular: "77.3M (49.9%)",
            opponent: "Kamala Harris",
            opponentElectoral: 226,
            states: "Won key swing states including Pennsylvania, Georgia, Michigan"
        },
        {
            year: 2020,
            winner: "Joe Biden",
            party: "Democratic",
            electoral: 306,
            popular: "81.3M (51.3%)",
            opponent: "Donald Trump",
            opponentElectoral: 232,
            states: "Flipped Arizona, Georgia, Michigan, Pennsylvania, Wisconsin"
        },
        {
            year: 2016,
            winner: "Donald Trump",
            party: "Republican",
            electoral: 304,
            popular: "63.0M (46.1%)",
            opponent: "Hillary Clinton",
            opponentElectoral: 227,
            states: "Won Michigan, Pennsylvania, Wisconsin"
        }
    ];

    const stateResults = {
        2024: {
            red: ["AL", "AK", "AR", "FL", "ID", "IN", "IA", "KS", "KY", "LA", "MS", "MO", "MT", "NE", "ND", "OH", "OK", "SC", "SD", "TN", "TX", "UT", "WV", "WY", "NC", "GA", "PA", "MI", "WI", "AZ", "NV"],
            blue: ["CA", "CO", "CT", "DE", "HI", "IL", "ME", "MD", "MA", "MN", "NH", "NJ", "NM", "NY", "OR", "RI", "VT", "VA", "WA", "DC"]
        },
        2020: {
            red: ["AL", "AK", "AR", "FL", "ID", "IN", "IA", "KS", "KY", "LA", "MS", "MO", "MT", "NE", "ND", "OH", "OK", "SC", "SD", "TN", "TX", "UT", "WV", "WY", "NC"],
            blue: ["CA", "CO", "CT", "DE", "HI", "IL", "ME", "MD", "MA", "MN", "NH", "NJ", "NM", "NY", "OR", "RI", "VT", "VA", "WA", "DC", "AZ", "GA", "MI", "NV", "PA", "WI"]
        },
        2016: {
            red: ["AL", "AK", "AR", "FL", "ID", "IN", "IA", "KS", "KY", "LA", "MS", "MO", "MT", "NE", "ND", "OH", "OK", "SC", "SD", "TN", "TX", "UT", "WV", "WY", "NC", "GA", "MI", "PA", "WI", "AZ"],
            blue: ["CA", "CO", "CT", "DE", "HI", "IL", "ME", "MD", "MA", "MN", "NH", "NJ", "NM", "NY", "OR", "RI", "VT", "VA", "WA", "DC", "NV"]
        }
    };

    const pollingBooths = [
        {
            id: 1,
            name: "Lincoln High School",
            address: "742 SE Cesar E Chavez Blvd, Portland, OR 97214",
            hours: "7:00 AM - 8:00 PM",
            lat: 45.5168,
            lng: -122.6229,
            waitTime: "5-10 min"
        },
        {
            id: 2,
            name: "Community Center East",
            address: "1234 SE Hawthorne Blvd, Portland, OR 97214",
            hours: "7:00 AM - 8:00 PM",
            lat: 45.5122,
            lng: -122.6545,
            waitTime: "15-20 min"
        },
        {
            id: 3,
            name: "Portland Public Library - Central",
            address: "801 SW 10th Ave, Portland, OR 97205",
            hours: "8:00 AM - 8:00 PM",
            lat: 45.5190,
            lng: -122.6820,
            waitTime: "< 5 min"
        },
        {
            id: 4,
            name: "Roosevelt Community Hall",
            address: "4515 NE 67th Ave, Portland, OR 97218",
            hours: "7:00 AM - 8:00 PM",
            lat: 45.5428,
            lng: -122.5945,
            waitTime: "10-15 min"
        }
    ];

    const getUserLocation = () => {
        setLoading(true);
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    setUserLocation({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    });
                    setLoading(false);
                },
                (error) => {
                    console.error("Error getting location:", error);
                    setUserLocation({ lat: 45.5152, lng: -122.6784 });
                    setLoading(false);
                }
            );
        } else {
            setUserLocation({ lat: 45.5152, lng: -122.6784 });
            setLoading(false);
        }
    };

    useEffect(() => {
        getUserLocation();
    }, []);

    const calculateDistance = (lat1, lng1, lat2, lng2) => {
        const R = 3959;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                            Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return (R * c).toFixed(1);
    };

    const sortedBooths = userLocation
        ? pollingBooths
                .map(booth => ({
                    ...booth,
                    distance: calculateDistance(userLocation.lat, userLocation.lng, booth.lat, booth.lng)
                }))
                .sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance))
                .filter(booth =>
                    searchQuery === '' ||
                    booth.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    booth.address.toLowerCase().includes(searchQuery.toLowerCase())
                )
        : [];

    const getDirections = (booth) => {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(booth.address)}`;
        window.open(url, '_blank');
    };

    const getStateColor = (stateCode) => {
        const currentResults = stateResults[selectedYear];
        if (currentResults.red.includes(stateCode)) return '#DC2626';
        if (currentResults.blue.includes(stateCode)) return '#2563EB';
        return '#9CA3AF';
    };

    useEffect(() => {
        if (activeTab === 'map' && typeof window.L !== 'undefined') {
            const mapContainer = document.getElementById('electoral-map');
            if (mapContainer && !mapContainer._leafletId) {
                const map = window.L.map('electoral-map').setView([37.8, -96], 4);

                window.L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-bright/{z}/{x}/{y}.png?apiKey=29163bba3ffc4d2687672973c887ffe6`, {
                    attribution: 'Â© Geoapify',
                    maxZoom: 20
                }).addTo(map);

                const statePolygons = {};

                const addStateLayer = async () => {
                    try {
                        const currentResults = stateResults[selectedYear];

                        const response = await fetch(
                            `https://api.geoapify.com/v1/boundaries/administrative?apiKey=29163bba3ffc4d2687672973c887ffe6&filters=US:US-*&limit=100`
                        );

                        if (!response.ok) return;

                        const data = await response.json();

                        data.features.forEach(feature => {
                            const stateName = feature.properties.state_code;
                            if (!stateName) return;

                            const isRed = currentResults.red.includes(stateName);
                            const isBlue = currentResults.blue.includes(stateName);

                            const color = isRed ? '#DC2626' : isBlue ? '#2563EB' : '#9CA3AF';

                            const layer = window.L.geoJSON(feature, {
                                style: {
                                    fillColor: color,
                                    fillOpacity: 0.6,
                                    color: 'white',
                                    weight: 2
                                },
                                onEachFeature: (feat, lyr) => {
                                    lyr.on('mouseover', function() {
                                        this.setStyle({ fillOpacity: 0.9 });
                                        setHoveredState(stateName);
                                    });
                                    lyr.on('mouseout', function() {
                                        this.setStyle({ fillOpacity: 0.6 });
                                        setHoveredState(null);
                                    });
                                }
                            }).addTo(map);

                            statePolygons[stateName] = layer;
                        });
                    } catch (err) {
                        console.error('Error loading map:', err);
                    }
                };

                addStateLayer();

                return () => {
                    map.remove();
                };
            }
        }
    }, [activeTab, selectedYear]);

    useEffect(() => {
        const script1 = document.createElement('script');
        script1.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        script1.async = true;
        document.head.appendChild(script1);

        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(link);

        return () => {
            document.head.removeChild(script1);
            document.head.removeChild(link);
        };
    }, []);

    return (
        <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-blue-50">
            <div className="bg-gradient-to-r from-red-600 via-purple-600 to-blue-600 text-white shadow-lg">
                <div className="max-w-6xl mx-auto px-4 py-6">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-3">
                            <div className="bg-white/20 p-3 rounded-xl backdrop-blur-sm">
                                <MapPin className="w-8 h-8" />
                            </div>
                            <div>
                                <h1 className="text-3xl font-bold">Vote America 2028</h1>
                                <p className="text-white/90 text-sm">Your complete election guide</p>
                            </div>
                        </div>
                        <button
                            onClick={getUserLocation}
                            className="bg-white/20 hover:bg-white/30 backdrop-blur-sm p-3 rounded-xl transition-all duration-200 hover:scale-105"
                            disabled={loading}
                        >
                            {loading ? <Loader className="w-6 h-6 animate-spin" /> : <Navigation className="w-6 h-6" />}
                        </button>
                    </div>
                </div>
            </div>

            <div className="max-w-6xl mx-auto px-4 -mt-6">
                <div className="bg-white rounded-2xl shadow-xl p-2 border border-gray-100 flex gap-2">
                    <button
                        onClick={() => setActiveTab('booths')}
                        className={`flex-1 py-3 px-4 rounded-xl font-semibold transition-all ${
                            activeTab === 'booths'
                                ? 'bg-gradient-to-r from-red-600 to-blue-600 text-white shadow-md'
                                : 'text-gray-600 hover:bg-gray-50'
                        }`}
                    >
                        <MapPin className="w-5 h-5 inline mr-2" />
                        Polling Booths
                    </button>
                    <button
                        onClick={() => setActiveTab('elections')}
                        className={`flex-1 py-3 px-4 rounded-xl font-semibold transition-all ${
                            activeTab === 'elections'
                                ? 'bg-gradient-to-r from-red-600 to-blue-600 text-white shadow-md'
                                : 'text-gray-600 hover:bg-gray-50'
                        }`}
                    >
                        <TrendingUp className="w-5 h-5 inline mr-2" />
                        2028 Race
                    </button>
                    <button
                        onClick={() => setActiveTab('map')}
                        className={`flex-1 py-3 px-4 rounded-xl font-semibold transition-all ${
                            activeTab === 'map'
                                ? 'bg-gradient-to-r from-red-600 to-blue-600 text-white shadow-md'
                                : 'text-gray-600 hover:bg-gray-50'
                        }`}
                    >
                        <Users className="w-5 h-5 inline mr-2" />
                        Electoral Map
                    </button>
                </div>
            </div>

            <div className="max-w-6xl mx-auto px-4 py-6">
                {activeTab === 'booths' && (
                    <>
                        <div className="mb-6">
                            <div className="bg-white rounded-2xl shadow-xl p-4 border border-gray-100">
                                <div className="relative">
                                    <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                                    <input
                                        type="text"
                                        placeholder="Search by name or address..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:outline-none transition-colors"
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {loading ? (
                                <div className="flex items-center justify-center py-12">
                                    <Loader className="w-8 h-8 animate-spin text-purple-600" />
                                </div>
                            ) : sortedBooths.length === 0 ? (
                                <div className="bg-white rounded-2xl shadow-lg p-8 text-center">
                                    <p className="text-gray-500">No polling booths found</p>
                                </div>
                            ) : (
                                sortedBooths.map((booth, index) => (
                                    <div
                                        key={booth.id}
                                        className={`bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden border-2 ${
                                            selectedBooth === booth.id ? 'border-purple-500 scale-[1.02]' : 'border-transparent'
                                        }`}
                                        onClick={() => setSelectedBooth(booth.id)}
                                    >
                                        <div className="p-6">
                                            <div className="flex items-start justify-between mb-4">
                                                <div className="flex-1">
                                                    <div className="flex items-center space-x-3 mb-2">
                                                        {index === 0 && (
                                                            <span className="bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                                                                NEAREST
                                                            </span>
                                                        )}
                                                        <h3 className="text-xl font-bold text-gray-800">{booth.name}</h3>
                                                    </div>
                                                    <p className="text-gray-600 mb-1">{booth.address}</p>
                                                    <div className="flex items-center space-x-4 text-sm text-gray-500 mt-3">
                                                        <div className="flex items-center space-x-1">
                                                            <Clock className="w-4 h-4" />
                                                            <span>{booth.hours}</span>
                                                        </div>
                                                        <div className="flex items-center space-x-1">
                                                            <MapPin className="w-4 h-4 text-purple-600" />
                                                            <span className="font-semibold text-purple-600">{booth.distance} mi</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex items-center justify-between pt-4 border-t border-gray-100">
                                                <div className="flex items-center space-x-2">
                                                    <div className={`w-3 h-3 rounded-full ${
                                                        booth.waitTime.includes('<') ? 'bg-green-500' :
                                                        booth.waitTime.includes('5-10') ? 'bg-yellow-500' : 'bg-orange-500'
                                                    }`}></div>
                                                    <span className="text-sm text-gray-600">Wait: {booth.waitTime}</span>
                                                </div>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        getDirections(booth);
                                                    }}
                                                    className="bg-gradient-to-r from-red-600 to-blue-600 hover:from-red-700 hover:to-blue-700 text-white px-6 py-2 rounded-xl font-semibold transition-all duration-200 hover:scale-105 shadow-md"
                                                >
                                                    Directions
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </>
                )}

                {activeTab === 'elections' && (
                    <div className="space-y-6">
                        <div className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl shadow-xl p-6 border-2 border-purple-200">
                            <div className="flex items-center space-x-3 mb-4">
                                <TrendingUp className="w-8 h-8 text-purple-600" />
                                <h2 className="text-2xl font-bold text-gray-800">2028 Predictions</h2>
                            </div>

                            <div className={`rounded-xl p-5 mb-4 border-2 ${
                                candidates2028.prediction.likelyWinner === 'Republican'
                                    ? 'bg-red-50 border-red-300'
                                    : 'bg-blue-50 border-blue-300'
                            }`}>
                                <h3 className="text-lg font-bold text-gray-800 mb-2">Predicted Winner</h3>
                                <p className={`text-2xl font-bold mb-2 ${
                                    candidates2028.prediction.likelyWinner === 'Republican' ? 'text-red-700' : 'text-blue-700'
                                }`}>
                                    {candidates2028.prediction.likelyWinner} Party
                                </p>
                                <p className="text-gray-700">Confidence: {candidates2028.prediction.confidence}</p>
                                <p className="text-sm text-gray-600 mt-2">{candidates2028.prediction.reasoning}</p>
                            </div>

                            <div className="bg-red-50 rounded-xl p-5 mb-4 border-2 border-red-200">
                                <h3 className="text-xl font-bold text-red-700 mb-3">Republican Candidates</h3>
                                <div className="space-y-3">
                                    {candidates2028.republican.map((candidate, i) => (
                                        <div key={i} className="bg-white rounded-lg p-4">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <p className="font-bold text-gray-800">{candidate.name}</p>
                                                    <p className="text-sm text-gray-600">{candidate.role}</p>
                                                </div>
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                    candidate.probability === 'High' ? 'bg-red-200 text-red-800' : 'bg-red-100 text-red-600'
                                                }`}>
                                                    {candidate.probability}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                                <h3 className="text-xl font-bold text-blue-700 mb-3">Democratic Candidates</h3>
                                <div className="space-y-3">
                                    {candidates2028.democratic.map((candidate, i) => (
                                        <div key={i} className="bg-white rounded-lg p-4">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <p className="font-bold text-gray-800">{candidate.name}</p>
                                                    <p className="text-sm text-gray-600">{candidate.role}</p>
                                                </div>
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                    candidate.probability === 'High' ? 'bg-blue-200 text-blue-800' : 'bg-blue-100 text-blue-600'
                                                }`}>
                                                    {candidate.probability}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <h2 className="text-2xl font-bold text-gray-800 flex items-center space-x-2">
                            <Award className="w-7 h-7 text-amber-500" />
                            <span>Past Elections</span>
                        </h2>

                        {electionHistory.map((election) => (
                            <div
                                key={election.year}
                                className={`rounded-2xl shadow-xl p-6 border-2 ${
                                    election.party === 'Republican'
                                        ? 'bg-gradient-to-br from-red-50 to-red-100 border-red-300'
                                        : 'bg-gradient-to-br from-blue-50 to-blue-100 border-blue-300'
                                }`}
                            >
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-3xl font-bold text-gray-800">{election.year}</h3>
                                    <span className={`px-4 py-2 rounded-full font-bold text-white ${
                                        election.party === 'Republican' ? 'bg-red-600' : 'bg-blue-600'
                                    }`}>
                                        {election.party}
                                    </span>
                                </div>

                                <div className="bg-white rounded-xl p-5 mb-3">
                                    <div className="flex items-center justify-between mb-3">
                                        <div>
                                            <p className="text-sm text-gray-500">Winner</p>
                                            <p className="text-2xl font-bold text-gray-800">{election.winner}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-sm text-gray-500">Electoral</p>
                                            <p className="text-3xl font-bold text-green-600">{election.electoral}</p>
                                        </div>
                                    </div>
                                    <p className="text-gray-600">Popular: {election.popular}</p>
                                </div>

                                <div className="bg-white/50 rounded-xl p-4">
                                    <p className="text-gray-700 mb-1">
                                        Defeated: {election.opponent} ({election.opponentElectoral} votes)
                                    </p>
                                    <p className="text-gray-600 text-sm">{election.states}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                )}

                {activeTab === 'map' && (
                    <div className="space-y-6">
                        <div className="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Interactive Electoral Map</h2>

                            <div className="flex gap-2 mb-6">
                                {[2024, 2020, 2016].map(year => (
                                    <button
                                        key={year}
                                        onClick={() => setSelectedYear(year)}
                                        className={`px-6 py-3 rounded-xl font-bold transition-all ${
                                            selectedYear === year
                                                ? 'bg-gradient-to-r from-red-600 to-blue-600 text-white shadow-lg'
                                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                        }`}
                                    >
                                        {year}
                                    </button>
                                ))}
                            </div>

                            <div className="bg-gray-50 rounded-xl p-6 mb-6">
                                <div id="electoral-map" style={{ height: '500px', width: '100%', borderRadius: '12px' }}></div>
                                {hoveredState && (
                                    <div className="text-center mt-4 p-3 bg-white rounded-lg shadow-md">
                                        <p className="font-bold text-lg">{hoveredState}</p>
                                        <p className={`text-sm ${
                                            stateResults[selectedYear].red.includes(hoveredState) ? 'text-red-600' : 'text-blue-600'
                                        }`}>
                                            {stateResults[selectedYear].red.includes(hoveredState) ? 'Republican' : 'Democratic'}
                                        </p>
                                    </div>
                                )}
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-red-50 rounded-xl p-4 border-2 border-red-300">
                                    <p className="text-sm text-red-600 font-semibold">Republican</p>
                                    <p className="text-3xl font-bold text-red-700">{stateResults[selectedYear].red.length}</p>
                                </div>
                                <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-300">
                                    <p className="text-sm text-blue-600 font-semibold">Democratic</p>
                                    <p className="text-3xl font-bold text-blue-700">{stateResults[selectedYear].blue.length}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}